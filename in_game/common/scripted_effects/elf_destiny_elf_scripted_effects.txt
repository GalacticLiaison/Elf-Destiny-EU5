assign_elf_race_trait_effect = {
	debug_log = "assign_elf_race_trait_effect"
	if = {
		limit = {
			inherited_elf_racial_score > 0
			inherited_elf_racial_score < 2
		}
		assign_race_trait = { trait = elf_tier_1}
	}
	if = {
		limit = {
			inherited_elf_racial_score >= 2
			inherited_elf_racial_score < 3
		}
		assign_race_trait = { trait = elf_tier_2}
	}
	if = {
		limit = {
			inherited_elf_racial_score >= 3
			inherited_elf_racial_score < 4
		}
		assign_race_trait = { trait = elf_tier_3}
	}
	if = {
		limit = {
			inherited_elf_racial_score >= 4
			inherited_elf_racial_score < 5
		}
		assign_race_trait = { trait = elf_tier_4}
	}
	if = {
		limit = {
			inherited_elf_racial_score >= 5
			inherited_elf_racial_score < 6
		}
		assign_race_trait = { trait = elf_tier_5}
	}
	if = {
		limit = {
			inherited_elf_racial_score >= 6
			inherited_elf_racial_score < 7
		}
		assign_race_trait = { trait = elf_tier_6}
	}
	if = {
		limit = {
			inherited_elf_racial_score >= 7
			inherited_elf_racial_score < 8
		}
		assign_race_trait = { trait = elf_tier_7}
	}
	if = {
		limit = {
			inherited_elf_racial_score >= 8
			inherited_elf_racial_score < 9
		}
		assign_race_trait = { trait = elf_tier_8}
	}
	if = {
		limit = {
			inherited_elf_racial_score >= 9
			inherited_elf_racial_score < 10
		}
		assign_race_trait = { trait = elf_tier_9}
	}
	if = {
		limit = {
			inherited_elf_racial_score >= 10
			inherited_elf_racial_score < 11
		}
		assign_race_trait = { trait = elf_tier_10}
	}
	if = {
		limit = {
			inherited_elf_racial_score >= 11
			inherited_elf_racial_score < 12
		}
		assign_race_trait = { trait = elf_tier_11}
	}
	if = {
		limit = {
			inherited_elf_racial_score >= 12
		}
		assign_race_trait = { trait = elf_tier_12}
	}
}

# increase_elf_race_level = {

# 	assign_race_trait = { trait = elf_tier_1}
# }

assign_race_trait = {
	add_character_modifier = {
		modifier = $trait$
		# mode = add_and_extend
	}

	set_variable = {
		name = character_race
		value = trait:$trait$
	}
}

remove_race_trait = {
	add_character_modifier = {
		modifier = $trait$
		# mode = add_and_extend
	}

	set_variable = {
		name = character_race
		value = trait:$trait$
	}
}


assign_bloodline_traits_at_birth_effect = {
	either_parent_genetic_inheritance = { trait = royal_elf_valerith }
	either_parent_genetic_inheritance = { trait = royal_elf_serelion }
	either_parent_genetic_inheritance = { trait = royal_elf_gwynthorn }
	either_parent_genetic_inheritance = { trait = royal_elf_thundarael }
	either_parent_genetic_inheritance = { trait = royal_elf_daelurin }
	either_parent_genetic_inheritance = { trait = royal_elf_lormelis }
}

# If either parent has the trait, the child will inherit it.
either_parent_genetic_inheritance = {
	if = {
		limit = {
			OR = {
				scope:character.father = {
					has_genetic_trait = { trait = $trait$ }
				}
				scope:character.mother = {
					has_genetic_trait = { trait = $trait$ }
				}
			}
		}

		scope:character ?= {
			assign_genetic_trait = { trait = $trait$}
		}
	}
}

genetic_inheritance_effect = {
	leveled_trait_inheritance = {trait = beauty}
	leveled_trait_inheritance = {trait = intellect}
	leveled_trait_inheritance = {trait = physique}

	if = { # there isn't a level 4 upgraded beauty trait yet
		limit = {
			NOT = {
				has_genetic_trait = { trait = beauty_good_4 }
			}
		}
		upgraded_beauty_inheritance = yes
	}

	single_trait_inheritance = {
		trait = fecund
		single_parent_chance = 33
	}
	single_trait_inheritance = {
		trait = giant
		single_parent_chance = 33
	}
	pure_blood_inheritance = yes

	random = { # chance to be born with a genetic trait not inherited
		chance = 5
		assign_random_genetic_trait = yes
	}
}

leveled_trait_inheritance = {
	set_variable = {
		name = trait_score
		value = inherited_$trait$_trait_score 
	}

	# Chance to reinforce genetic trait
	if = {
		limit = {
			var:trait_score > 0
		}

		random = {
			chance = 25
			change_variable = {
				name = trait_score
				add = 1 
			}
		}
	}

	if = {
		limit = {
			var:trait_score >= 4
			owner = {
				has_religious_aspect = religious_aspect:noble_husbandry
			}
		}

		assign_genetic_trait = { trait = $trait$_good_4}
	}
	else_if = {
		limit = {
			var:trait_score >= 3
		}

		assign_genetic_trait = { trait = $trait$_good_3}
	}
	else_if = {
		limit = {
			var:trait_score >= 2
		}

		assign_genetic_trait = { trait = $trait$_good_2}
	}
	else_if = {
		limit = {
			var:trait_score >= 1
		}

		assign_genetic_trait = { trait = $trait$_good_1}
	}
	else_if = {
		limit = {
			var:trait_score <= -1
		}

		assign_genetic_trait = { trait = $trait$_bad_1}
	}
	else_if = {
		limit = {
			var:trait_score <= -2
		}

		assign_genetic_trait = { trait = $trait$_bad_2}
	}
	else_if = {
		limit = {
			var:trait_score <= -3
		}

		assign_genetic_trait = { trait = $trait$_bad_3}
	}
}

single_trait_inheritance = {
	if = {
		limit = {
			AND = {
				scope:character.father = {
					has_genetic_trait = { trait = $trait$ }
				}
				scope:character.mother = {
					has_genetic_trait = { trait = $trait$ }
				}
			}
		}

		scope:character ?= {
			assign_genetic_trait = { trait = $trait$}
		}
	}
	else_if = {
		limit = {
			OR = {
				scope:character.father = {
					has_genetic_trait = { trait = $trait$ }
				}
				scope:character.mother = {
					has_genetic_trait = { trait = $trait$ }
				}
			}
		}

		random = {
			chance = $single_parent_chance$
			scope:character ?= {
				assign_genetic_trait = { trait = $trait$}
			}
		}
	}
}

# Chance Character is born with new genetic trait regardless of parents
assign_random_genetic_trait = {
	random_list = {
		0 = { # Beauty Bad 1
			modifier = {
				add = 3
				beauty_trait_score = 0
			}
			assign_genetic_trait = { trait = beauty_bad_1}
		}
		0 = { # Beauty Bad 2
			modifier = {
				add = 2
				beauty_trait_score = 0
			}
			assign_genetic_trait = { trait = beauty_bad_2}
		}
		0 = { # Beauty Bad 3
			modifier = {
				add = 1
				beauty_trait_score = 0
			}
			assign_genetic_trait = { trait = beauty_bad_3}
		} 
		0 = { # Beauty Good 1
			modifier = {
				add = 6
				beauty_trait_score = 0
			}
			assign_genetic_trait = { trait = beauty_good_1}
		} 
		0 = { # Beauty Good 2
			modifier = {
				add = 4
				beauty_trait_score = 0
			}
			assign_genetic_trait = { trait = beauty_good_2}
		} 
		0 = { # Beauty Good 3
			modifier = {
				add = 2
				beauty_trait_score = 0
			}
			assign_genetic_trait = { trait = beauty_good_3}
		}

		0 = { # Intellect Bad 1
			modifier = {
				add = 3
				intellect_trait_score = 0
			}
			assign_genetic_trait = { trait = intellect_bad_1}
		}
		0 = { # Intellect Bad 2
			modifier = {
				add = 2
				intellect_trait_score = 0
			}
			assign_genetic_trait = { trait = intellect_bad_2}
		}
		0 = { # Intellect Bad 3
			modifier = {
				add = 1
				intellect_trait_score = 0
			}
			assign_genetic_trait = { trait = intellect_bad_3}
		} 
		0 = { # Intellect Good 1
			modifier = {
				add = 6
				intellect_trait_score = 0
			}
			assign_genetic_trait = { trait = intellect_good_1}
		} 
		0 = { # Intellect Good 2
			modifier = {
				add = 4
				intellect_trait_score = 0
			}
			assign_genetic_trait = { trait = intellect_good_2}
		} 
		0 = { # Intellect Good 3
			modifier = {
				add = 2
				intellect_trait_score = 0
			}
			assign_genetic_trait = { trait = intellect_good_3}
		} 


		0 = { # Physique Bad 1
			modifier = {
				add = 3
				physique_trait_score = 0
			}
			assign_genetic_trait = { trait = physique_bad_1}
		}
		0 = { # Physique Bad 2
			modifier = {
				add = 2
				physique_trait_score = 0
			}
			assign_genetic_trait = { trait = physique_bad_2}
		}
		0 = { # Physique Bad 3
			modifier = {
				add = 1
				physique_trait_score = 0
			}
			assign_genetic_trait = { trait = physique_bad_3}
		} 
		0 = { # Physique Good 1
			modifier = {
				add = 6
				physique_trait_score = 0
			}
			assign_genetic_trait = { trait = physique_good_1}
		} 
		0 = { # Physique Good 2
			modifier = {
				add = 4
				physique_trait_score = 0
			}
			assign_genetic_trait = { trait = physique_good_2}
		} 
		0 = { # Physique Good 3
			modifier = {
				add = 2
				physique_trait_score = 0
			}
			assign_genetic_trait = { trait = physique_good_3}
		}


		0 = { # Fecund
			modifier = {
				add = 3
				NOT = {
					has_character_modifier = fecund
				}
			}
			assign_genetic_trait = { trait = fecund}
		}
		0 = { # Giant
			modifier = {
				add = 3
				NOT = {
					has_character_modifier = fecund
				}
			}
			assign_genetic_trait = { trait = giant}
		}

		1 = {} 
	}
}

pure_blood_inheritance = {
	single_trait_inheritance = {
		trait = pure_blooded
		single_parent_chance = 50
	}

	if = {
		limit = {
			NOT = { has_character_modifier = pure_blooded }
			OR = {
				scope:character ?= {
					AND = {
						exists = father
						exists = mother
						father = {has_dynasty = yes}
						mother = {has_dynasty = yes}
						father.dynasty = mother.dynasty
					}
				}
				scope:character ?= {
					AND = {
						exists = father
						exists = mother
						father = {
							is_close_relative = scope:character.mother
						}
					}
				}
			}
		}

		random = {
			chance = 35
			scope:character ?= {
				assign_genetic_trait = { trait = pure_blooded}
			}
		}
	}
}

### Unconventional and Exotic beauty traits ###
upgraded_beauty_inheritance = {

	if = { # First we will see if the child will inherit from their parents
		limit = {
			scope:character ?= {
				OR = {
					has_genetic_trait = { trait = beauty_good_1 }
					has_genetic_trait = { trait = beauty_good_2 }
					has_genetic_trait = { trait = beauty_good_3 }
				}
			}
		}
		inherit_upgraded_beauty = { beauty_type = unconventional }
		inherit_upgraded_beauty = { beauty_type = exotic }
	}

	if = { # they still have a normal beauty chance, so they failed to inherit, random small chance to upgrade
		limit = {
			scope:character ?= {
				OR = {
					has_genetic_trait = { trait = beauty_good_1 }
					has_genetic_trait = { trait = beauty_good_2 }
					has_genetic_trait = { trait = beauty_good_3 }
				}
			}
		}
		random_list = {
			1 = {
				modifier = { # Beguiling Nature greatly increases odds 
					scope:character ?= {
						owner = {
							has_religious_aspect = religious_aspect:beguiling_nature
						}
					}
					add = 49
				}

				random_list = {
					2 = { # Unconventional
						upgrade_beauty_type = { new_beauty_type = unconventional }
					} 
					1 = { # Exotic
						upgrade_beauty_type = { new_beauty_type = exotic }
					}
					3 = {} # used to make odds even worse
				}
			}
			99 = {} # nothing happens
		}
	}
	else = {
		# extremely small chance to gain a random unconventional or exotic beauty trait without inheriting it
		random = {
			chance = 1
			modifier = { # Beguiling Nature greatly increases odds 
				scope:character ?= {
					owner = {
						has_religious_aspect = religious_aspect:beguiling_nature
					}
				}
				add = 10
			}

			scope:character ?= {
				random_list = {
					4 = { # Unconventional Beauty Good 1
						assign_genetic_trait = { trait = unconventional_beauty_good_1}
					} 
					3 = { # Unconventional Beauty Good 2
						assign_genetic_trait = { trait = unconventional_beauty_good_2}
					} 
					2 = { # Unconventional Beauty Good 3
						assign_genetic_trait = { trait = unconventional_beauty_good_3}
					} 
					3 = { # Exotic Beauty Good 1
						assign_genetic_trait = { trait = exotic_beauty_good_1}
					} 
					2 = { # Exotic Beauty Good 2
						assign_genetic_trait = { trait = exotic_beauty_good_2}
					} 
					1 = { # Exotic Beauty Good 3
						assign_genetic_trait = { trait = exotic_beauty_good_3}
					}
					5 = {} # used to make odds even worse
				}
			}
		}
	}

  # small cahnce to upgrade unconventioanl beauty trait
}

inherit_upgraded_beauty = {
	if = { # if both parent had a rare beauty trait, guaranteed to improve child's beauty trait
		limit = {
			AND = {
				scope:character.father = {
					OR = {
						has_genetic_trait = { trait = $beauty_type$_beauty_good_1 }
						has_genetic_trait = { trait = $beauty_type$_beauty_good_2 }
						has_genetic_trait = { trait = $beauty_type$_beauty_good_3 }
					}
				}
				scope:character.mother = {
					OR = {
						has_genetic_trait = { trait = $beauty_type$_beauty_good_1 }
						has_genetic_trait = { trait = $beauty_type$_beauty_good_2 }
						has_genetic_trait = { trait = $beauty_type$_beauty_good_3 }
					}
				}
			}
		}

		scope:character ?= {
			upgrade_beauty_type = { new_beauty_type = $beauty_type$ }
		}
	}
	else_if = { # if one parent had a rare beauty trait, good chance to improve child's beauty trait
		limit = {
			OR = {
				scope:character.father = {
					OR = {
						has_genetic_trait = { trait = $beauty_type$_beauty_good_1 }
						has_genetic_trait = { trait = $beauty_type$_beauty_good_2 }
						has_genetic_trait = { trait = $beauty_type$_beauty_good_3 }
					}
				}
				scope:character.mother = {
					OR = {
						has_genetic_trait = { trait = $beauty_type$_beauty_good_1 }
						has_genetic_trait = { trait = $beauty_type$_beauty_good_2 }
						has_genetic_trait = { trait = $beauty_type$_beauty_good_3 }
					}
				}
			}
		}

		random = {
			chance = 50
			scope:character ?= {
				upgrade_beauty_type = { new_beauty_type = $beauty_type$ }
			}
		}
	}

}

upgrade_beauty_type = {
	if = {
		limit = {
			has_genetic_trait = { trait = beauty_good_1 }
		}
		remove_genetic_trait = { trait = beauty_good_1 }
		assign_genetic_trait = { trait = $new_beauty_type$_beauty_good_1 }
	}
	else_if = {
		limit = {
			has_genetic_trait = { trait = beauty_good_2 }
		}
		remove_genetic_trait = { trait = beauty_good_2 }
		assign_genetic_trait = { trait = $new_beauty_type$_beauty_good_2 }
	}
	else_if = {
		limit = {
			has_genetic_trait = { trait = beauty_good_3 }
		}
		remove_genetic_trait = { trait = beauty_good_3 }
		assign_genetic_trait = { trait = $new_beauty_type$_beauty_good_3 }
	}
}

assign_genetic_trait = {
	add_character_modifier = {
		modifier = $trait$
		# mode = add_and_extend
	}

	add_to_variable_list = {
		name = genetic_traits
		target = trait:$trait$
	}
}

remove_genetic_trait = {
	remove_character_modifier = $trait$

	remove_list_variable = {
		name = genetic_traits
		target = trait:$trait$
	}
}

give_genetic_traits_to_starter_characters_effect = {
	# needed for GUI stuff
	set_global_variable = {
		name = human_trait
		value = trait:human
	}

	every_country = {
		every_character = {
			assign_any_missing_genetic_traits = yes
			give_starter_elf_trait = yes

			# random = { # TODO: seed some genetic traits into starter characters
			# 	# will want to have checks to see they dont already have a genetic trait
			# }
		}
	}
}

give_starter_elf_trait = {
	if = {
		limit = {
			religion = religion:aeluran
			is_any_elf_type = no
		}

		assign_race_trait = { trait = elf_tier_2 }
	}
}

# Used to give Setup characters traits that correspond to their character modifiers
assign_any_missing_genetic_traits = {
	assign_race_trait_from_modifier = { trait = elf_tier_1 }
	assign_race_trait_from_modifier = { trait = elf_tier_2 }
	assign_race_trait_from_modifier = { trait = elf_tier_3 }
	assign_race_trait_from_modifier = { trait = elf_tier_4 }
	assign_race_trait_from_modifier = { trait = elf_tier_5 }
	assign_race_trait_from_modifier = { trait = elf_tier_6 }
	assign_race_trait_from_modifier = { trait = elf_tier_7 }
	assign_race_trait_from_modifier = { trait = elf_tier_8 }
	assign_race_trait_from_modifier = { trait = elf_tier_9 }
	assign_race_trait_from_modifier = { trait = elf_tier_10 }
	assign_race_trait_from_modifier = { trait = elf_tier_11 }
	assign_race_trait_from_modifier = { trait = elf_tier_12 }

	assign_genetic_trait_from_modifier = { trait = royal_elf_valerith }
	assign_genetic_trait_from_modifier = { trait = royal_elf_serelion }
	assign_genetic_trait_from_modifier = { trait = royal_elf_gwynthorn }
	assign_genetic_trait_from_modifier = { trait = royal_elf_thundarael }
	assign_genetic_trait_from_modifier = { trait = royal_elf_daelurin }
	assign_genetic_trait_from_modifier = { trait = royal_elf_lormelis }

	assign_genetic_trait_from_modifier = { trait = beauty_bad_1 }
	assign_genetic_trait_from_modifier = { trait = beauty_bad_2 }
	assign_genetic_trait_from_modifier = { trait = beauty_bad_3 }
	assign_genetic_trait_from_modifier = { trait = beauty_good_1 }
	assign_genetic_trait_from_modifier = { trait = beauty_good_2 }
	assign_genetic_trait_from_modifier = { trait = beauty_good_3 }
	assign_genetic_trait_from_modifier = { trait = beauty_good_4 }
	assign_genetic_trait_from_modifier = { trait = unconventional_beauty_good_1 }
	assign_genetic_trait_from_modifier = { trait = unconventional_beauty_good_2 }
	assign_genetic_trait_from_modifier = { trait = unconventional_beauty_good_3 }
	assign_genetic_trait_from_modifier = { trait = exotic_beauty_good_1 }
	assign_genetic_trait_from_modifier = { trait = exotic_beauty_good_2 }
	assign_genetic_trait_from_modifier = { trait = exotic_beauty_good_3 }
	assign_genetic_trait_from_modifier = { trait = intellect_bad_1 }
	assign_genetic_trait_from_modifier = { trait = intellect_bad_2 }
	assign_genetic_trait_from_modifier = { trait = intellect_bad_3 }
	assign_genetic_trait_from_modifier = { trait = intellect_good_1 }
	assign_genetic_trait_from_modifier = { trait = intellect_good_2 }
	assign_genetic_trait_from_modifier = { trait = intellect_good_3 }
	assign_genetic_trait_from_modifier = { trait = intellect_good_4 }
	assign_genetic_trait_from_modifier = { trait = physique_bad_1 }
	assign_genetic_trait_from_modifier = { trait = physique_bad_2 }
	assign_genetic_trait_from_modifier = { trait = physique_bad_3 }
	assign_genetic_trait_from_modifier = { trait = physique_good_1 }
	assign_genetic_trait_from_modifier = { trait = physique_good_2 }
	assign_genetic_trait_from_modifier = { trait = physique_good_3 }
	assign_genetic_trait_from_modifier = { trait = physique_good_4 }
	assign_genetic_trait_from_modifier = { trait = pure_blooded }
	assign_genetic_trait_from_modifier = { trait = fecund }
	assign_genetic_trait_from_modifier = { trait = giant }
}

assign_genetic_trait_from_modifier = {
	if = {
		limit = {
			has_character_modifier = $trait$
			NOT = {
				is_target_in_variable_list = {
					name = genetic_traits
					target = trait:$trait$
				}
			}
		}

		add_to_variable_list = {
			name = genetic_traits
			target = trait:$trait$
		}
	}
}

assign_race_trait_from_modifier = {
	if = {
		limit = {
			has_character_modifier = $trait$
			OR = {
				NOT = { has_variable = character_race }
				NOT = { var:character_race = trait:$trait$ }
			}
		}

		set_variable = {
			name = character_race
			value = trait:$trait$
		}
	}
}


ascension_effect = {
	if = {
		limit = { is_any_elf_type = no }
		assign_race_trait = { trait = elf_tier_1}
	}
	else_if = {
		limit = { has_racial_trait = { trait = elf_tier_1 } }
		upgrade_elf_race_trait = {
			old_level = 1
			new_level = 2
		}
	}
	else_if = {
		limit = { has_racial_trait = { trait = elf_tier_2 } }
		upgrade_elf_race_trait = {
			old_level = 2
			new_level = 3
		}
	}
	else_if = {
		limit = { has_racial_trait = { trait = elf_tier_3 } }
		upgrade_elf_race_trait = {
			old_level = 3
			new_level = 4
		}
	}
	else_if = {
		limit = { has_racial_trait = { trait = elf_tier_4 } }
		upgrade_elf_race_trait = {
			old_level = 4
			new_level = 5
		}
	}
	else_if = {
		limit = { has_racial_trait = { trait = elf_tier_5 } }
		upgrade_elf_race_trait = {
			old_level = 5
			new_level = 6
		}
	}
	else_if = {
		limit = { has_racial_trait = { trait = elf_tier_6 } }
		upgrade_elf_race_trait = {
			old_level = 6
			new_level = 7
		}
	}
	else_if = {
		limit = { has_racial_trait = { trait = elf_tier_7 } }
		upgrade_elf_race_trait = {
			old_level = 7
			new_level = 8
		}
	}
	else_if = {
		limit = { has_racial_trait = { trait = elf_tier_8 } }
		upgrade_elf_race_trait = {
			old_level = 8
			new_level = 9
		}
	}
	else_if = {
		limit = { has_racial_trait = { trait = elf_tier_9 } }
		upgrade_elf_race_trait = {
			old_level = 9
			new_level = 10
		}
	}
	else_if = {
		limit = { has_racial_trait = { trait = elf_tier_10 } }
		upgrade_elf_race_trait = {
			old_level = 10
			new_level = 11
		}
	}
		else_if = {
		limit = { has_racial_trait = { trait = elf_tier_11 } }
		upgrade_elf_race_trait = {
			old_level = 11
			new_level = 12
		}
	}
}

upgrade_elf_race_trait = {
	remove_race_trait = { trait = elf_tier_$old_level$}
	assign_race_trait = { trait = elf_tier_$new_level$}
}